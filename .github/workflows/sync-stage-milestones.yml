name: Sync Stage Labels to Milestones

# Automatically create and assign milestones based on stage labels
# Supports 11-stage neurology-inspired pipeline: signal, design, grid, line, mcp, pulse, synapse, overload, velocity, vibe, whole
# Enables milestone-based progress tracking, burndown charts, and planning

on:
  issues:
    types: [labeled, unlabeled]
  pull_request:
    types: [labeled, unlabeled]

# Prevent concurrent runs for the same issue/PR to ensure deterministic milestone assignment
concurrency:
  group: milestone-sync-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  issues: write
  pull-requests: write

jobs:
  sync-milestone:
    runs-on: ubuntu-latest
    name: Sync Stage Label to Milestone
    
    steps:
      - name: Check if label is a stage label
        id: check-label
        uses: actions/github-script@v7
        with:
          script: |
            const labelName = context.payload.label?.name || '';
            
            // Define stage-to-milestone mapping
            // Maps stage labels to their corresponding milestone names
            // 11-Stage Neurology-Inspired Pipeline: Energy, Frequency, Vibration, Sound
            const stageMilestoneMap = {
              'stage:signal': 'SIGNAL (Intake)',
              'stage:design': 'DESIGN (Specify)',
              'stage:grid': 'GRID (Plan)',
              'stage:line': 'LINE (Decompose)',
              'stage:mcp': 'MCP (Implement)',
              'stage:pulse': 'PULSE (Verify)',
              'stage:synapse': 'SYNAPSE (Integrate)',
              'stage:overload': 'OVERLOAD (Harden)',
              'stage:velocity': 'VELOCITY (Release)',
              'stage:vibe': 'VIBE (Operate)',
              'stage:whole': 'WHOLE (Learn)'
            };
            
            // Check if the label is a stage label
            if (!stageMilestoneMap[labelName]) {
              console.log(`Label "${labelName}" is not a stage label. No action needed.`);
              core.setOutput('is_stage_label', 'false');
              return;
            }
            
            core.setOutput('is_stage_label', 'true');
            core.setOutput('stage_label', labelName);
            core.setOutput('milestone_name', stageMilestoneMap[labelName]);
            
            console.log(`Detected stage label: ${labelName} â†’ Milestone: ${stageMilestoneMap[labelName]}`);

      - name: Get or create milestone
        id: milestone
        if: steps.check-label.outputs.is_stage_label == 'true' && github.event.action == 'labeled'
        uses: actions/github-script@v7
        with:
          script: |
            const milestoneName = '${{ steps.check-label.outputs.milestone_name }}';
            
            // Get all milestones (open and closed), with pagination to avoid missing any
            const milestones = await github.paginate(
              github.rest.issues.listMilestones,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all'
              }
            );
            
            // Check if milestone exists
            let milestone = milestones.find(m => m.title === milestoneName);
            
            if (milestone) {
              console.log(`Milestone "${milestoneName}" already exists (ID: ${milestone.number})`);
            } else {
              // Create the milestone
              console.log(`Creating milestone: ${milestoneName}`);
              const { data: newMilestone } = await github.rest.issues.createMilestone({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: milestoneName,
                description: `Milestone for tracking ${milestoneName} stage progress`
              });
              milestone = newMilestone;
              console.log(`Created milestone "${milestoneName}" (ID: ${milestone.number})`);
            }
            
            core.setOutput('milestone_number', milestone.number);
            return milestone.number;

      - name: Assign milestone to issue/PR
        if: steps.check-label.outputs.is_stage_label == 'true' && github.event.action == 'labeled'
        uses: actions/github-script@v7
        with:
          script: |
            const milestoneNumber = parseInt('${{ steps.milestone.outputs.milestone_number }}');
            const issueNumber = context.issue.number;
            const issuePR = context.payload.pull_request ? 'PR' : 'Issue';
            
            // Get current issue/PR details using issues API (works for both issues and PRs)
            const { data: current } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            if (current.milestone) {
              console.log(`Replacing existing milestone "${current.milestone.title}" with new milestone`);
            }
            
            // Assign the new milestone (overwrites any existing milestone)
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              milestone: milestoneNumber
            });
            
            console.log(`Assigned ${issuePR} #${issueNumber} to milestone "${milestoneNumber}"`);
            
            // Post a comment to inform users
            const milestoneName = '${{ steps.check-label.outputs.milestone_name }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ðŸŽ¯ **Milestone Updated**\n\nThis ${issuePR} has been assigned to the **${milestoneName}** milestone based on the stage label.\n\n_This milestone tracks all items in the ${milestoneName} stage for better progress visibility._`
            });

      - name: Remove milestone on unlabeled
        if: steps.check-label.outputs.is_stage_label == 'true' && github.event.action == 'unlabeled'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const issuePR = context.payload.pull_request ? 'PR' : 'Issue';
            const removedLabel = '${{ steps.check-label.outputs.stage_label }}';
            
            // Define stage-to-milestone mapping
            // 11-Stage Neurology-Inspired Pipeline: Energy, Frequency, Vibration, Sound
            const stageMilestoneMap = {
              'stage:signal': 'SIGNAL (Intake)',
              'stage:design': 'DESIGN (Specify)',
              'stage:grid': 'GRID (Plan)',
              'stage:line': 'LINE (Decompose)',
              'stage:mcp': 'MCP (Implement)',
              'stage:pulse': 'PULSE (Verify)',
              'stage:synapse': 'SYNAPSE (Integrate)',
              'stage:overload': 'OVERLOAD (Harden)',
              'stage:velocity': 'VELOCITY (Release)',
              'stage:vibe': 'VIBE (Operate)',
              'stage:whole': 'WHOLE (Learn)'
            };
            
            // Get current issue/PR to check milestone and labels
            const { data: current } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            // Only process if current milestone matches the removed stage label
            const milestoneName = '${{ steps.check-label.outputs.milestone_name }}';
            if (current.milestone && current.milestone.title === milestoneName) {
              console.log(`Milestone "${milestoneName}" matches removed label`);
              
              // Check if there are other stage labels
              const otherStageLabels = current.labels
                .map(l => l.name)
                .filter(name => name.startsWith('stage:') && name !== removedLabel);
              
              if (otherStageLabels.length > 0) {
                // Reassign to the first remaining stage label's milestone (latest label wins)
                const newStageLabel = otherStageLabels[0];
                const newMilestoneName = stageMilestoneMap[newStageLabel];
                
                console.log(`Found other stage label(s): ${otherStageLabels.join(', ')}`);
                console.log(`Reassigning to milestone for: ${newStageLabel}`);
                
                // Get all milestones to find the new one
                const milestones = await github.paginate(
                  github.rest.issues.listMilestones,
                  {
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    state: 'all'
                  }
                );
                
                const newMilestone = milestones.find(m => m.title === newMilestoneName);
                
                if (newMilestone) {
                  // Reassign to the new milestone
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    milestone: newMilestone.number
                  });
                  console.log(`Reassigned ${issuePR} #${issueNumber} to milestone "${newMilestoneName}"`);
                } else {
                  console.log(`Milestone "${newMilestoneName}" not found, removing milestone instead`);
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    milestone: null
                  });
                }
              } else {
                // No other stage labels, remove milestone
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  milestone: null
                });
                
                console.log(`Removed milestone from ${issuePR} #${issueNumber}`);
              }
            } else {
              console.log(`${issuePR} #${issueNumber} is not in milestone "${milestoneName}", no action needed`);
            }
