# Pull Request Security Checks
# @copilot-context: Security validation for pull requests
# Runs dependency review to catch vulnerable dependencies before merge
# Also performs basic PR validation checks
#
# Note: Dependency review requires GitHub Advanced Security for private repos
# The workflow will skip dependency review gracefully if not available
#
# @copilot-review: Ensure security thresholds align with project requirements

name: PR Security & Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: ["main", "develop"]

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  dependency-review:
    name: Review Dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Dependency Review
        id: dependency_review
        uses: actions/dependency-review-action@v4
        continue-on-error: true
        with:
          # Fail on high or critical vulnerabilities
          fail-on-severity: high
          
          # Deny specific licenses if needed
          # deny-licenses: GPL-3.0, AGPL-3.0
          
          # Comment results on PR
          comment-summary-in-pr: always
          
          # Show vulnerability details
          vulnerability-check: true
          
      - name: Summary
        if: always()
        env:
          REVIEW_OUTCOME: ${{ steps.dependency_review.outcome }}
        run: |
          if [ "$REVIEW_OUTCOME" == "success" ]; then
            echo "### âœ… Dependency Security Review Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All dependencies have been scanned for known vulnerabilities." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See the dependency review results above." >> $GITHUB_STEP_SUMMARY
          elif [ "$REVIEW_OUTCOME" == "failure" ]; then
            echo "### âš ï¸  Dependency Review Not Available" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Dependency review requires GitHub Advanced Security to be enabled." >> $GITHUB_STEP_SUMMARY
            echo "This is a paid feature for private repositories." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Alternative:** Use Dependabot alerts (free) or enable GHAS for full dependency scanning." >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ Dependency Review Status Unknown" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The dependency review step completed with status: $REVIEW_OUTCOME" >> $GITHUB_STEP_SUMMARY
          fi

  pr-validation:
    name: Validate PR Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate PR Title
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Ensure PR title is not empty
          if [ -z "$PR_TITLE" ]; then
            echo "âŒ PR title is empty. Please provide a descriptive title."
            exit 1
          fi
          
          # Check if PR title is descriptive (at least 10 characters)
          if [ "${#PR_TITLE}" -lt 10 ]; then
            echo "âŒ PR title is too short. Please provide a descriptive title."
            exit 1
          fi
          
          echo "âœ… PR title validation passed"
      
      - name: Check for SOMAS artifacts
        env:
          HEAD_REF: ${{ github.head_ref }}
        run: |
          # Check if this is a SOMAS-generated PR
          if [[ "$HEAD_REF" == somas/* ]]; then
            echo "ðŸ¤– This is a SOMAS-generated PR"
            
            # Validate that required SOMAS artifacts exist
            if [ -d ".somas/projects" ]; then
              echo "âœ… SOMAS project structure found"
            else
              echo "âš ï¸  No SOMAS project structure found"
            fi
          fi
      
      - name: PR Summary
        if: always()
        env:
          HEAD_REF: ${{ github.head_ref }}
          BASE_REF: ${{ github.base_ref }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          echo "### ðŸ“‹ PR Validation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`$HEAD_REF\`" >> $GITHUB_STEP_SUMMARY
          echo "**Base:** \`$BASE_REF\`" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** @$PR_AUTHOR" >> $GITHUB_STEP_SUMMARY
