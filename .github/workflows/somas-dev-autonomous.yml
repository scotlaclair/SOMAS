name: SOMAS Autonomous Dev Pipeline

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  autonomous-execution:
    name: Autonomous Pipeline Execution
    # Only run on somas:dev label - let somas-pipeline.yml handle somas-project only cases
    # This prevents duplicate pipeline executions when somas-project is added
    if: github.event.label.name == 'somas:dev'
    runs-on: ubuntu-latest
    timeout-minutes: 300

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Use SOMAS_PAT if available for cascading triggers, otherwise GITHUB_TOKEN
          token: ${{ secrets.SOMAS_PAT || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pyyaml filelock

      - name: Configure Git & Create Branch
        env:
          PROJECT_ID: "project-${{ github.event.issue.number }}"
        run: |
          git config --global user.name "SOMAS Bot"
          git config --global user.email "somas-bot@users.noreply.github.com"

          BRANCH_NAME="somas/$PROJECT_ID"
          # Use ls-remote to check existence on server directly
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME"; then
            echo "Branch exists remotely, fetching and checking out..."
            git fetch origin "$BRANCH_NAME:$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
          else
            echo "Creating new branch $BRANCH_NAME..."
            git checkout -b "$BRANCH_NAME"
          fi

      - name: Initialize Pipeline
        env:
          GITHUB_TOKEN: ${{ secrets.SOMAS_PAT || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          PROJECT_ID: "project-${{ github.event.issue.number }}"
        run: |
          echo "Starting autonomous pipeline for Issue #$ISSUE_NUMBER"
          # Initialize project structure and metadata
          python3 -c "import os; from somas.core.state_manager import StateManager; StateManager().initialize_project(os.environ['PROJECT_ID'], int(os.environ['ISSUE_NUMBER']), os.environ['ISSUE_TITLE'])"

      - name: Save Issue Context
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          PROJECT_ID: "project-${{ github.event.issue.number }}"
        run: |
          python3 -c "import os; import pathlib; path = pathlib.Path('.somas/projects/' + os.environ['PROJECT_ID'] + '/artifacts/project_request.md'); path.parent.mkdir(parents=True, exist_ok=True); path.write_text(os.environ['ISSUE_BODY'])"

      - name: Execute Autonomous Stages
        env:
          GITHUB_TOKEN: ${{ secrets.SOMAS_PAT || secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          PROJECT_ID: "project-${{ github.event.issue.number }}"
        run: |
          # Execute the pipeline stages sequentially for POC
          # This script should handle the logic defined in AUTONOMOUS_PIPELINE_SUMMARY.md
          python3 somas/core/runner.py --mode autonomous --project_id "$PROJECT_ID"

      - name: Commit and Push Changes
        env:
          PROJECT_ID: "project-${{ github.event.issue.number }}"
        run: |
          BRANCH_NAME="somas/$PROJECT_ID"
          git add .
          git commit -m "Autonomous execution for $PROJECT_ID" || echo "No changes to commit"
          git push -u origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.SOMAS_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.issue.number;
            const projectId = `project-${issueNumber}`;
            const branchName = `somas/${projectId}`;

            // Verify branch exists before attempting PR creation
            try {
              await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: branchName
              });
              core.info(`✓ Branch ${branchName} exists`);
            } catch (error) {
              core.warning(`Branch ${branchName} does not exist yet. This may be normal if no commits were made.`);
              
              // Post comment about PR creation status
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: [
                  '## ℹ️ PR Creation Deferred',
                  '',
                  `Branch \`${branchName}\` was not found.`,
                  '',
                  'This is normal if the autonomous pipeline did not make any commits yet.',
                  'The PR will be created after the first commit is pushed to the branch.',
                  '',
                  `**Status:** Pipeline execution continuing...`
                ].join('\n')
              });
              
              return; // Skip PR creation, don't fail the workflow
            }

            try {
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[${projectId}] Autonomous Implementation`,
                body: `## Autonomous SOMAS Pipeline Complete

                **Project:** ${projectId}
                **Issue:** Closes #${issueNumber}

                All stages completed successfully.

                ## SOMAS Agent Assignments

                ### Phase 1: Signal & Design
                - [ ] Stage 1: @copilot somas-planner
                - [ ] Stage 2: @copilot somas-specifier
                - [ ] Stage 3: @copilot somas-simulator
                - [ ] Stage 4: @copilot somas-decomposer

                ### Phase 2: Implementation & Validation
                - [ ] Stage 5: @copilot somas-implementer
                - [ ] Stage 6: @copilot somas-validator
                - [ ] Stage 6: @copilot somas-tester
                - [ ] Stage 6: @copilot somas-security
                - [ ] Stage 6: @copilot somas-reviewer

                ### Phase 3: Integration & Release
                - [ ] Stage 7: @copilot somas-merger
                - [ ] Stage 9: @copilot somas-deployer

                ### Phase 4: Operations & Learning
                - [ ] Stage 10: @copilot somas-operator
                - [ ] Stage 11: @copilot somas-analyzer

                **Artifacts:**
                - \`initial_plan.yml\`
                - \`SPEC.md\`
                - \`execution_plan.yml\`
                - \`ARCHITECTURE.md\`
                - Implementation code
                - Test suite
                - Review report

                **Auto-merge:** Enabled (dev environment)`,
                head: branchName,
                base: 'dev'
              });

              core.info(`✓ PR #${pr.data.number} created successfully`);
              
              // Add labels to the PR
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                labels: ['somas:ready-for-review', 'somas-generated']
              });
              core.info('✓ Added labels: somas:ready-for-review, somas-generated');
              
              core.info('Auto-merge will be handled by PR Checklist Completion Detector workflow');
              core.info('Agents must review and check off items before auto-merge is enabled');

            } catch (error) {
              // Handle case where branch is already up to date
              if (error.message && error.message.includes("No commits between")) {
                console.log("PR creation skipped: Branch is already up to date with base.");
              } else if (error.message && error.message.includes("A pull request already exists")) {
                console.log("PR already exists for this branch.");
              } else {
                core.setFailed(`Failed to create PR: ${error.message}`);
              }
            }
