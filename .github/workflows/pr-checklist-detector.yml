name: PR Checklist Completion Detector

# Detects when all agent review checkboxes in the "SOMAS Agent Assignments" section
# of a PR description are completed. When all boxes are checked, automatically adds
# the "auto-merge-approved" label to enable auto-merge workflows.
#
# This ensures only PRs reviewed by all required agents progress to auto-merge,
# maintaining quality gates without manual verification overhead.

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check-agent-assignments:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Agent Assignment Checklist
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prBody = context.payload.pull_request.body || '';
            
            core.info('='.repeat(60));
            core.info('PR Checklist Completion Detector');
            core.info('='.repeat(60));
            core.info(`PR #${prNumber}`);
            core.info(`PR Body length: ${prBody.length} characters`);
            
            // Extract the "SOMAS Agent Assignments" section
            // This section contains checkboxes for agent reviews
            const agentSectionRegex = /##\s*SOMAS Agent Assignments\s*\n([\s\S]*?)(?=\n##|\n---|\z)/i;
            const match = prBody.match(agentSectionRegex);
            
            if (!match) {
              core.info('❌ No "SOMAS Agent Assignments" section found in PR body');
              core.info('This workflow only applies to SOMAS-generated PRs with agent assignments');
              core.setOutput('has_section', 'false');
              core.setOutput('skip', 'true');
              return;
            }
            
            const agentSection = match[1];
            core.info('✓ Found "SOMAS Agent Assignments" section');
            core.info(`Section length: ${agentSection.length} characters`);
            
            // Count unchecked boxes: [ ]
            // Count checked boxes: [x] or [X]
            const uncheckedBoxes = (agentSection.match(/- \[ \]/g) || []).length;
            const checkedBoxes = (agentSection.match(/- \[[xX]\]/g) || []).length;
            const totalBoxes = uncheckedBoxes + checkedBoxes;
            
            core.info('');
            core.info('Checklist Status:');
            core.info(`  Total boxes: ${totalBoxes}`);
            core.info(`  Checked: ${checkedBoxes}`);
            core.info(`  Unchecked: ${uncheckedBoxes}`);
            
            if (totalBoxes === 0) {
              core.info('⚠️  No checkboxes found in agent assignments section');
              core.setOutput('has_section', 'true');
              core.setOutput('has_checkboxes', 'false');
              core.setOutput('skip', 'true');
              return;
            }
            
            const allChecked = uncheckedBoxes === 0;
            core.info('');
            core.info(`Status: ${allChecked ? '✅ ALL CHECKS COMPLETE' : '⏳ PENDING REVIEWS'}`);
            
            // Get current labels on the PR
            const currentLabels = context.payload.pull_request.labels.map(l => l.name);
            const hasAutoMergeLabel = currentLabels.includes('auto-merge-approved');
            
            core.info('');
            core.info(`Current "auto-merge-approved" label: ${hasAutoMergeLabel ? 'PRESENT' : 'ABSENT'}`);
            
            core.setOutput('has_section', 'true');
            core.setOutput('has_checkboxes', 'true');
            core.setOutput('skip', 'false');
            core.setOutput('all_checked', allChecked.toString());
            core.setOutput('has_auto_merge_label', hasAutoMergeLabel.toString());
            core.setOutput('checked_count', checkedBoxes);
            core.setOutput('unchecked_count', uncheckedBoxes);
            core.setOutput('total_count', totalBoxes);
            
            core.info('='.repeat(60));
      
      - name: Add Auto-Merge Approval Label
        if: |
          steps.check.outputs.skip != 'true' &&
          steps.check.outputs.all_checked == 'true' &&
          steps.check.outputs.has_auto_merge_label != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const checkedCount = '${{ steps.check.outputs.checked_count }}';
            
            core.info(`✅ All ${checkedCount} agent reviews completed!`);
            core.info('Adding "auto-merge-approved" label...');
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['auto-merge-approved']
            });
            
            core.info('✓ Label added successfully');
            
            // Post a comment on the PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: '## ✅ All Agent Reviews Complete\n\n' +
                    `All ${checkedCount} required agent reviews have been checked off in the **SOMAS Agent Assignments** section.\n\n` +
                    '**Status:** Auto-merge approved\n' +
                    '**Label:** `auto-merge-approved` has been automatically added\n\n' +
                    'This PR is now eligible for automatic merging if all other required checks pass and branch protection rules permit.\n\n' +
                    '---\n' +
                    '*Automated by PR Checklist Completion Detector*'
            });
            
            core.info('✓ Status comment posted');
      
      - name: Remove Auto-Merge Approval Label
        if: |
          steps.check.outputs.skip != 'true' &&
          steps.check.outputs.all_checked != 'true' &&
          steps.check.outputs.has_auto_merge_label == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const uncheckedCount = '${{ steps.check.outputs.unchecked_count }}';
            const checkedCount = '${{ steps.check.outputs.checked_count }}';
            const totalCount = '${{ steps.check.outputs.total_count }}';
            
            core.info(`⏳ Agent reviews incomplete: ${checkedCount}/${totalCount} completed`);
            core.info('Removing "auto-merge-approved" label...');
            
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                name: 'auto-merge-approved'
              });
              
              core.info('✓ Label removed successfully');
              
              // Post a comment on the PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: '## ⏳ Agent Reviews Incomplete\n\n' +
                      'The agent review checklist has been updated and is no longer complete.\n\n' +
                      `**Status:** ${checkedCount}/${totalCount} reviews completed (${uncheckedCount} remaining)\n` +
                      '**Label:** `auto-merge-approved` has been automatically removed\n\n' +
                      'Please ensure all required agent reviews are completed before this PR can be auto-merged.\n\n' +
                      '---\n' +
                      '*Automated by PR Checklist Completion Detector*'
              });
              
              core.info('✓ Status comment posted');
            } catch (error) {
              if (error.status === 404) {
                core.info('Label was already removed, no action needed');
              } else {
                throw error;
              }
            }
      
      - name: Log Completion
        if: steps.check.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const allChecked = '${{ steps.check.outputs.all_checked }}' === 'true';
            const checkedCount = '${{ steps.check.outputs.checked_count }}';
            const totalCount = '${{ steps.check.outputs.total_count }}';
            
            core.info('');
            core.info('='.repeat(60));
            core.info('Final Status');
            core.info('='.repeat(60));
            core.info(`Checklist: ${checkedCount}/${totalCount} completed`);
            core.info(`Auto-merge approved: ${allChecked ? 'YES' : 'NO'}`);
            core.info('='.repeat(60));
