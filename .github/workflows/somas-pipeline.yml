name: SOMAS Pipeline

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID to process'
        required: true
        type: string
      stage:
        description: 'Pipeline stage to execute'
        required: false
        type: choice
        options:
          - all
          - ideation
          - specification
          - simulation
          - architecture
          - implementation
          - validation
          - staging

permissions:
  contents: write
  issues: write
  pull-requests: write
  projects: write

jobs:
  initialize-pipeline:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'somas-project')
    outputs:
      project_id: ${{ steps.setup.outputs.project_id }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Project
        id: setup
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # Generate project ID from issue number
          PROJECT_ID="project-${ISSUE_NUMBER}"
          echo "project_id=${PROJECT_ID}" >> $GITHUB_OUTPUT
          
          # Create project directory structure
          mkdir -p .somas/projects/${PROJECT_ID}/{artifacts,logs}
          
          # Create project metadata using Python for safe JSON encoding
          python3 << 'PYTHON_SCRIPT'
          import json
          import os
          from datetime import datetime
          
          project_id = os.environ['PROJECT_ID']
          issue_number = int(os.environ['ISSUE_NUMBER'])
          title = os.environ['ISSUE_TITLE']
          created_at = datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ')
          
          metadata = {
              'project_id': project_id,
              'issue_number': issue_number,
              'title': title,
              'created_at': created_at,
              'status': 'initializing',
              'current_stage': 'ideation',
              'stages_completed': []
          }
          
          with open(f'.somas/projects/{project_id}/metadata.json', 'w') as f:
              json.dump(metadata, f, indent=2)
          PYTHON_SCRIPT
          
          export PROJECT_ID="${PROJECT_ID}"
          echo "Initialized project: ${PROJECT_ID}"
      
      - name: Create GitHub Project Board
        uses: actions/github-script@v7
        with:
          script: |
            const projectId = '${{ steps.setup.outputs.project_id }}';
            
            // Trigger project creation workflow
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'somas-project-event',
              client_payload: {
                project_id: projectId,
                action: 'create'
              }
            });
      
      - name: Commit project initialization
        run: |
          git config user.name "SOMAS Bot"
          git config user.email "somas-bot@users.noreply.github.com"
          
          # Check if there are any changes to commit
          if git status --porcelain .somas/projects/ | grep . >/dev/null; then
            git add .somas/projects/
            git commit -m "Initialize SOMAS project ${{ steps.setup.outputs.project_id }}"
            git push
          else
            echo "No changes to commit"
          fi
  
  stage-1-ideation:
    runs-on: ubuntu-latest
    needs: [initialize-pipeline]
    if: |
      always() &&
      (needs.initialize-pipeline.result == 'success' || github.event.inputs.stage == 'ideation' || github.event.inputs.stage == 'all')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
      
      - name: Run Ideation Stage
        run: |
          PROJECT_ID="${{ needs.initialize-pipeline.outputs.project_id || github.event.inputs.project_id }}"
          echo "Running ideation stage for ${PROJECT_ID}"
          
          # Placeholder for actual ideation agent execution
          mkdir -p .somas/projects/${PROJECT_ID}/artifacts
          echo "# Initial Plan" > .somas/projects/${PROJECT_ID}/artifacts/initial_plan.md
          echo "Stage 1: Ideation completed" >> .somas/projects/${PROJECT_ID}/artifacts/initial_plan.md
  
  stage-2-specification:
    runs-on: ubuntu-latest
    needs: [initialize-pipeline, stage-1-ideation]
    if: |
      always() &&
      (needs.stage-1-ideation.result == 'success' || github.event.inputs.stage == 'specification' || github.event.inputs.stage == 'all')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
      
      - name: Run Specification Stage
        run: |
          PROJECT_ID="${{ needs.initialize-pipeline.outputs.project_id || github.event.inputs.project_id }}"
          echo "Running specification stage for ${PROJECT_ID}"
          
          # Specification artifact generation
          ARTIFACT_DIR=".somas/projects/${PROJECT_ID}/artifacts"
          SPEC_TEMPLATE=".somas/templates/SPEC.md"
          SPEC_OUTPUT="${ARTIFACT_DIR}/SPEC.md"
          
          mkdir -p "${ARTIFACT_DIR}"
          
          if [ -f "${SPEC_TEMPLATE}" ]; then
            echo "Using existing specification template at ${SPEC_TEMPLATE}"
            cp "${SPEC_TEMPLATE}" "${SPEC_OUTPUT}"
          else
            echo "Specification template not found at ${SPEC_TEMPLATE}; generating a basic specification file instead."
            cat > "${SPEC_OUTPUT}" << 'SPECEOF'
            # Specification for project ${PROJECT_ID}
            
            This is an auto-generated specification artifact for the project.
            
            Please update this document with detailed functional, non-functional, and interface requirements for the project.
            SPECEOF
          fi
          
          echo "Stage 2: Specification completed"
      
      - name: Update Project Status
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'somas-project-event',
              client_payload: {
                project_id: '${{ needs.initialize-pipeline.outputs.project_id || github.event.inputs.project_id }}',
                action: 'update',
                stage: 'specification'
              }
            });
  
  stage-3-simulation:
    runs-on: ubuntu-latest
    needs: [initialize-pipeline, stage-2-specification]
    if: |
      always() &&
      (needs.stage-2-specification.result == 'success' || github.event.inputs.stage == 'simulation' || github.event.inputs.stage == 'all')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
      
      - name: Run Simulation Stage
        run: |
          PROJECT_ID="${{ needs.initialize-pipeline.outputs.project_id || github.event.inputs.project_id }}"
          echo "Running simulation stage for ${PROJECT_ID}"
          
          # Simulation artifact generation
          ARTIFACT_DIR=".somas/projects/${PROJECT_ID}/artifacts"
          PLAN_TEMPLATE=".somas/templates/execution_plan.yml"
          PLAN_OUTPUT="${ARTIFACT_DIR}/execution_plan.yml"
          
          mkdir -p "${ARTIFACT_DIR}"
          
          if [ -f "${PLAN_TEMPLATE}" ]; then
            echo "Using existing execution plan template at ${PLAN_TEMPLATE}"
            cp "${PLAN_TEMPLATE}" "${PLAN_OUTPUT}"
          else
            echo "Execution plan template not found at ${PLAN_TEMPLATE}; generating a basic execution plan file instead."
            cat > "${PLAN_OUTPUT}" << 'PLANEOF'
            optimal_execution_plan:
              phase_1:
                name: "Initial Phase"
                parallel_tasks: []
                sequential_tasks: []
            simulation_results:
              mean_duration_hours: 0
              p90_duration_hours: 0
            critical_path: []
            PLANEOF
          fi
          
          echo "Stage 3: Simulation completed"
      
      - name: Create Task Issues
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'somas-project-event',
              client_payload: {
                project_id: '${{ needs.initialize-pipeline.outputs.project_id || github.event.inputs.project_id }}',
                action: 'update',
                stage: 'simulation'
              }
            });
  
  stage-4-architecture:
    runs-on: ubuntu-latest
    needs: [initialize-pipeline, stage-3-simulation]
    if: |
      always() &&
      (needs.stage-3-simulation.result == 'success' || github.event.inputs.stage == 'architecture' || github.event.inputs.stage == 'all')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Run Architecture Stage
        run: |
          PROJECT_ID="${{ needs.initialize-pipeline.outputs.project_id || github.event.inputs.project_id }}"
          echo "Running architecture stage for ${PROJECT_ID}"
          echo "Stage 4: Architecture completed"
  
  stage-5-implementation:
    runs-on: ubuntu-latest
    needs: [initialize-pipeline, stage-4-architecture]
    if: |
      always() &&
      (needs.stage-4-architecture.result == 'success' || github.event.inputs.stage == 'implementation' || github.event.inputs.stage == 'all')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Run Implementation Stage
        run: |
          PROJECT_ID="${{ needs.initialize-pipeline.outputs.project_id || github.event.inputs.project_id }}"
          echo "Running implementation stage for ${PROJECT_ID}"
          echo "Stage 5: Implementation completed"
  
  stage-6-validation:
    runs-on: ubuntu-latest
    needs: [initialize-pipeline, stage-5-implementation]
    if: |
      always() &&
      (needs.stage-5-implementation.result == 'success' || github.event.inputs.stage == 'validation' || github.event.inputs.stage == 'all')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Run Validation Stage
        run: |
          PROJECT_ID="${{ needs.initialize-pipeline.outputs.project_id || github.event.inputs.project_id }}"
          echo "Running validation stage for ${PROJECT_ID}"
          echo "Stage 6: Validation completed"
  
  stage-7-staging:
    runs-on: ubuntu-latest
    needs: [initialize-pipeline, stage-6-validation]
    if: |
      always() &&
      (needs.stage-6-validation.result == 'success' || github.event.inputs.stage == 'staging' || github.event.inputs.stage == 'all')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Run Staging Stage
        run: |
          PROJECT_ID="${{ needs.initialize-pipeline.outputs.project_id || github.event.inputs.project_id }}"
          echo "Running staging stage for ${PROJECT_ID}"
          echo "Stage 7: Staging completed"
      
      - name: Close Project
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'somas-project-event',
              client_payload: {
                project_id: '${{ needs.initialize-pipeline.outputs.project_id || github.event.inputs.project_id }}',
                action: 'close'
              }
            });
  
  record-metrics:
    runs-on: ubuntu-latest
    needs: [stage-7-staging]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Record Pipeline Metrics
        run: |
          PROJECT_ID="${{ needs.initialize-pipeline.outputs.project_id || github.event.inputs.project_id }}"
          
          # Record metrics to analytics
          mkdir -p .somas/analytics/runs
          cat > .somas/analytics/runs/${PROJECT_ID}_metrics.json << EOF
          {
            "project_id": "${PROJECT_ID}",
            "completed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "stages": {
              "ideation": "${{ needs.stage-1-ideation.result }}",
              "specification": "${{ needs.stage-2-specification.result }}",
              "simulation": "${{ needs.stage-3-simulation.result }}",
              "architecture": "${{ needs.stage-4-architecture.result }}",
              "implementation": "${{ needs.stage-5-implementation.result }}",
              "validation": "${{ needs.stage-6-validation.result }}",
              "staging": "${{ needs.stage-7-staging.result }}"
            }
          }
          EOF
          
          echo "Recorded metrics for ${PROJECT_ID}"
